import streamlit as st
import sys
import os
import sqlite3
import uuid
import time

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from src.agent.main_agent import MainAgent
from src.processing.ingest_single_file import process_and_ingest_single_pdf
from src.utils import get_current_hcm_time_iso
from src.config import *

# --- C·∫•u h√¨nh trang v√† kh·ªüi t·∫°o Agent ---
st.set_page_config(page_title="Lumin AI Agent", page_icon="‚ú®", layout="wide")

@st.cache_resource
def load_agent():
    agent = MainAgent()
    return agent

main_agent = load_agent()

@st.cache_data(ttl=30)
def get_user_assets_tree(user_id: str) -> dict:
    if not user_id: return {}
    assets_tree = {}
    try:
        conn = sqlite3.connect(SQL_DATABASE_PATH)
        cursor = conn.cursor()
        ws_query = "SELECT T1.id, T1.name FROM Workspace AS T1 JOIN User_Workspace_Membership AS T2 ON T1.id = T2.workspace_id WHERE T2.user_id = ?"
        cursor.execute(ws_query, (user_id,))
        workspaces = cursor.fetchall()
        if not workspaces: return {}
        for ws_id, ws_name in workspaces: assets_tree[ws_id] = {'name': ws_name, 'spaces': {}}
        ws_ids = list(assets_tree.keys())
        sp_query = f"SELECT T1.id, T1.name, T1.workspace_id FROM Space AS T1 JOIN User_Space_Membership AS T2 ON T1.id = T2.space_id WHERE T2.user_id = ? AND T1.workspace_id IN ({','.join('?' for _ in ws_ids)})"
        cursor.execute(sp_query, [user_id] + ws_ids)
        spaces = cursor.fetchall()
        if not spaces: return assets_tree
        space_map = {}
        for sp_id, sp_name, ws_id in spaces:
            if ws_id in assets_tree:
                assets_tree[ws_id]['spaces'][sp_id] = {'name': sp_name, 'documents': []}
                space_map[sp_id] = ws_id
        sp_ids = list(space_map.keys())
        if not sp_ids: return assets_tree
        doc_query = f"SELECT id, filename, space_id FROM PDF_Document WHERE space_id IN ({','.join('?' for _ in sp_ids)})"
        cursor.execute(doc_query, sp_ids)
        documents = cursor.fetchall()
        for doc_id, doc_name, sp_id in documents:
            if sp_id in space_map:
                ws_id = space_map[sp_id]
                assets_tree[ws_id]['spaces'][sp_id]['documents'].append({'id': doc_id, 'name': doc_name})
        conn.close()
        return assets_tree
    except Exception as e:
        st.error(f"Could not fetch user assets tree: {e}")
        return {}

def get_db_connection(): 
    return sqlite3.connect(SQL_DATABASE_PATH)

def create_workspace(ws_name: str, user_id: str) -> str:
    conn = get_db_connection()
    cursor = conn.cursor()
    new_ws_id = f"ws_{uuid.uuid4().hex[:10]}"
    current_time = get_current_hcm_time_iso()
    cursor.execute("INSERT INTO Workspace (id, name, created_at, updated_at) VALUES (?, ?, ?, ?)",
                   (new_ws_id, ws_name, current_time, current_time))
    cursor.execute("INSERT INTO User_Workspace_Membership (user_id, workspace_id) VALUES (?, ?)",
                   (user_id, new_ws_id))
    conn.commit()
    conn.close()
    return new_ws_id

def create_space(sp_name: str, workspace_id: str, user_id: str) -> str:
    conn = get_db_connection()
    cursor = conn.cursor()
    new_sp_id = f"sp_{uuid.uuid4().hex[:10]}"
    current_time = get_current_hcm_time_iso()
    cursor.execute("INSERT INTO Space (id, name, workspace_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?)",
                   (new_sp_id, sp_name, workspace_id, current_time, current_time))
    cursor.execute("INSERT INTO User_Space_Membership (user_id, space_id) VALUES (?, ?)",
                   (user_id, new_sp_id))
    conn.commit()
    conn.close()
    return new_sp_id

# --- Qu·∫£n l√Ω Session State ---
if "messages" not in st.session_state: 
    st.session_state.messages = []
if "current_user" not in st.session_state: 
    st.session_state.current_user = None
if "upload_step" not in st.session_state: 
    st.session_state.upload_step = 1
if "ws_choice" not in st.session_state: 
    st.session_state.ws_choice = "S·ª≠ d·ª•ng Workspace c√≥ s·∫µn"
if "sp_choice" not in st.session_state: 
    st.session_state.sp_choice = "S·ª≠ d·ª•ng Space c√≥ s·∫µn"

def reset_upload_flow():
    """Reset to√†n b·ªô upload workflow"""
    st.session_state.upload_step = 1
    st.session_state.ws_choice = "S·ª≠ d·ª•ng Workspace c√≥ s·∫µn"
    st.session_state.sp_choice = "S·ª≠ d·ª•ng Space c√≥ s·∫µn"
    
    # X√≥a c√°c key c·ªßa widget v√† c√°c key "CHOSEN"
    keys_to_delete = [
        "new_ws_name", "selected_ws_id", "new_sp_name", "final_space_id", "uploaded_file",
        "CHOSEN_ws_choice", "CHOSEN_ws_id", "CHOSEN_new_ws_name",
        "CHOSEN_sp_choice", "CHOSEN_space_id", "CHOSEN_new_sp_name"
    ]
    for key in keys_to_delete:
        if key in st.session_state:
            del st.session_state[key]

# --- Giao di·ªán (UI) ---
st.title("‚ú® Lumin AI - Agent Demo")

with st.sidebar:
    st.header("üë• User Selection")
    
    def on_user_change():
        """Callback khi user thay ƒë·ªïi - reset upload flow v√† clear cache"""
        reset_upload_flow()
        st.cache_data.clear()
        # Force clear cache c·ªßa get_user_assets_tree
        get_user_assets_tree.clear()

    users = {"Alice": "alice_01", "Bob": "bob_02"}
    user_names = list(users.keys())
    current_user_name = next((name for name, uid in users.items() 
                             if uid == st.session_state.current_user), None)
    current_index = user_names.index(current_user_name) if current_user_name else None
    
    selected_user_name = st.selectbox(
        "Ch·ªçn ng∆∞·ªùi d√πng:", 
        options=user_names, 
        index=current_index, 
        placeholder="Select a user...", 
        on_change=on_user_change, 
        key="user_selector"
    )
    st.session_state.current_user = users[selected_user_name] if selected_user_name else None

    if st.session_state.current_user:
        st.success(f"Logged in as **{selected_user_name}**.")
    st.divider()
    
    # File Explorer
    if st.session_state.current_user:
        with st.expander("üóÇÔ∏è File Explorer", expanded=True):
            # Force refresh assets tree m·ªói l·∫ßn render
            get_user_assets_tree.clear()
            assets_tree = get_user_assets_tree(st.session_state.current_user)
            if assets_tree:
                for ws_id, ws_data in assets_tree.items():
                    with st.expander(f"üóÇÔ∏è **{ws_data['name']}** `({ws_id})`"):
                        if ws_data['spaces']:
                            for sp_id, sp_data in ws_data['spaces'].items():
                                with st.expander(f"üìÅ {sp_data['name']} `({sp_id})`"):
                                    if sp_data['documents']:
                                        for doc in sp_data['documents']:
                                            st.markdown(f"üìÑ {doc['name']}")
                                    else: 
                                        st.caption("*No documents in this space*")
                        else: 
                            st.caption("*No spaces in this workspace*")
            else: 
                st.info("You don't have any assets yet.")
    st.divider()

    # --- UPLOAD WIZARD ---
    if st.session_state.current_user:
        with st.expander("üì§ Upload PDF", expanded=False):
            assets_tree = get_user_assets_tree(st.session_state.current_user)

            # B∆Ø·ªöC 1: Ch·ªçn Workspace
            if st.session_state.upload_step == 1:
                st.markdown("##### B∆∞·ªõc 1: Ch·ªçn Workspace")
                st.radio("H√†nh ƒë·ªông:", 
                        ["S·ª≠ d·ª•ng Workspace c√≥ s·∫µn", "T·∫°o Workspace m·ªõi"], 
                        key="ws_choice")
                
                if st.session_state.ws_choice == "S·ª≠ d·ª•ng Workspace c√≥ s·∫µn":
                    ws_options = {ws_id: data['name'] for ws_id, data in assets_tree.items()} if assets_tree else {}
                    if ws_options:
                        st.selectbox("Ch·ªçn Workspace:", 
                                   options=list(ws_options.keys()), 
                                   format_func=lambda ws_id: ws_options.get(ws_id, "N/A"), 
                                   key="selected_ws_id")
                    else: 
                        st.info("B·∫°n ch∆∞a c√≥ Workspace n√†o.")
                else:
                    st.text_input("T√™n Workspace m·ªõi:", key="new_ws_name")
                
                if st.button("Ti·∫øp t·ª•c ‚Üí"):
                    # L∆∞u l·ª±a ch·ªçn c·ªßa B∆∞·ªõc 1
                    st.session_state.CHOSEN_ws_choice = st.session_state.ws_choice
                    if st.session_state.ws_choice == "S·ª≠ d·ª•ng Workspace c√≥ s·∫µn":
                        st.session_state.CHOSEN_ws_id = st.session_state.get('selected_ws_id')
                    else:
                        st.session_state.CHOSEN_new_ws_name = st.session_state.get('new_ws_name')
                    
                    st.session_state.upload_step = 2
                    st.rerun()

            # B∆Ø·ªöC 2: Ch·ªçn Space
            elif st.session_state.upload_step == 2:
                st.markdown("##### B∆∞·ªõc 2: Ch·ªçn Space")
                
                # Hi·ªÉn th·ªã workspace ƒë√£ ch·ªçn
                if st.session_state.CHOSEN_ws_choice == "T·∫°o Workspace m·ªõi":
                    st.info(f"Workspace m·ªõi: **{st.session_state.CHOSEN_new_ws_name}**")
                elif st.session_state.get('CHOSEN_ws_id'):
                    ws_name = assets_tree.get(st.session_state.CHOSEN_ws_id, {}).get('name', 'N/A')
                    st.info(f"ƒê√£ ch·ªçn: **{ws_name}**")
                
                st.radio("H√†nh ƒë·ªông:", 
                        ["S·ª≠ d·ª•ng Space c√≥ s·∫µn", "T·∫°o Space m·ªõi"], 
                        key="sp_choice")
                
                if st.session_state.sp_choice == "S·ª≠ d·ª•ng Space c√≥ s·∫µn":
                    if st.session_state.CHOSEN_ws_choice == "T·∫°o Workspace m·ªõi":
                        st.warning("Ph·∫£i t·∫°o Space m·ªõi cho Workspace m·ªõi.")
                    else:
                        space_options = assets_tree.get(st.session_state.CHOSEN_ws_id, {}).get('spaces', {})
                        if space_options:
                            st.selectbox("Ch·ªçn Space:", 
                                       options=list(space_options.keys()), 
                                       format_func=lambda sp_id: space_options[sp_id]['name'], 
                                       key="final_space_id")
                        else: 
                            st.warning("Workspace n√†y ch∆∞a c√≥ Space n√†o.")
                else: 
                    st.text_input("T√™n Space m·ªõi:", key="new_sp_name")
                
                col1, col2 = st.columns(2)
                with col1:
                    if st.button("‚Üê Quay l·∫°i"):
                        st.session_state.upload_step = 1
                        st.rerun()
                with col2:
                    if st.button("Ti·∫øp t·ª•c ‚Üí "):
                        # L∆∞u l·ª±a ch·ªçn c·ªßa B∆∞·ªõc 2
                        st.session_state.CHOSEN_sp_choice = st.session_state.sp_choice
                        if st.session_state.sp_choice == "S·ª≠ d·ª•ng Space c√≥ s·∫µn":
                            st.session_state.CHOSEN_space_id = st.session_state.get('final_space_id')
                        else:
                            st.session_state.CHOSEN_new_sp_name = st.session_state.get('new_sp_name')
                        
                        st.session_state.upload_step = 3
                        st.rerun()
            
            # B∆Ø·ªöC 3: Upload file
            elif st.session_state.upload_step == 3:
                st.markdown("##### B∆∞·ªõc 3: T·∫£i file l√™n")
                st.file_uploader("Ch·ªçn m·ªôt file PDF", type="pdf", key="uploaded_file")
                
                col1, col2 = st.columns(2)
                with col1:
                    if st.button("‚Üê Quay l·∫°i "):
                        st.session_state.upload_step = 2
                        st.rerun()
                with col2:
                    if st.button("‚ö° Process & Upload"):
                        with st.spinner("ƒêang x·ª≠ l√Ω..."):
                            try:
                                uploaded_file = st.session_state.uploaded_file
                                user_id = st.session_state.current_user
                                resolved_ws_id = None
                                resolved_final_space_id = None

                                # X·ª≠ l√Ω Workspace
                                if st.session_state.CHOSEN_ws_choice == "S·ª≠ d·ª•ng Workspace c√≥ s·∫µn":
                                    resolved_ws_id = st.session_state.CHOSEN_ws_id
                                elif st.session_state.CHOSEN_ws_choice == "T·∫°o Workspace m·ªõi":
                                    resolved_ws_id = create_workspace(
                                        st.session_state.CHOSEN_new_ws_name, user_id
                                    )
                                
                                # X·ª≠ l√Ω Space
                                if st.session_state.CHOSEN_sp_choice == "S·ª≠ d·ª•ng Space c√≥ s·∫µn":
                                    resolved_final_space_id = st.session_state.CHOSEN_space_id
                                elif st.session_state.CHOSEN_sp_choice == "T·∫°o Space m·ªõi":
                                    if not resolved_ws_id: 
                                        raise ValueError("Kh√¥ng th·ªÉ t·∫°o Space m·ªõi v√¨ kh√¥ng c√≥ Workspace.")
                                    resolved_final_space_id = create_space(
                                        st.session_state.CHOSEN_new_sp_name, 
                                        resolved_ws_id, 
                                        user_id
                                    )

                                if not uploaded_file: 
                                    raise ValueError("Vui l√≤ng ch·ªçn file.")
                                if not resolved_final_space_id: 
                                    raise ValueError("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c Space.")

                                # L∆∞u v√† x·ª≠ l√Ω file
                                save_path = os.path.join(RAW_DATA_PATH, uploaded_file.name)
                                with open(save_path, "wb") as f: 
                                    f.write(uploaded_file.getbuffer())
                                
                                success, message = process_and_ingest_single_pdf(
                                    file_path=save_path, 
                                    space_id=resolved_final_space_id, 
                                    owner_id=user_id
                                )
                                
                                if success:
                                    st.success("Upload th√†nh c√¥ng!")
                                    # Clear cache ƒë·ªÉ refresh file explorer
                                    st.cache_data.clear()
                                    get_user_assets_tree.clear()
                                    time.sleep(1)
                                    reset_upload_flow()
                                    st.rerun()
                                else: 
                                    st.error(message)
                            except Exception as e:
                                st.error(f"L·ªói: {e}")
            
            # N√∫t h·ªßy (hi·ªán ·ªü m·ªçi b∆∞·ªõc tr·ª´ b∆∞·ªõc 1)
            if st.session_state.upload_step > 1:
                if st.button("H·ªßy v√† b·∫Øt ƒë·∫ßu l·∫°i"):
                    reset_upload_flow()
                    st.rerun()

# --- Chat UI ---
if not st.session_state.current_user:
    st.warning("Vui l√≤ng ch·ªçn m·ªôt ng∆∞·ªùi d√πng ·ªü thanh b√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.")
else:
    # Hi·ªÉn th·ªã l·ªãch s·ª≠ chat
    for message in st.session_state.messages:
        with st.chat_message(message["role"]): 
            st.markdown(message["content"])
    
    # Input chat
    if prompt := st.chat_input("H·ªèi AI Agent ƒëi·ªÅu g√¨?"):
        # Th√™m v√† hi·ªÉn th·ªã tin nh·∫Øn user
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"): 
            st.markdown(prompt)
        
        # X·ª≠ l√Ω v√† hi·ªÉn th·ªã response
        with st.chat_message("assistant"):
            response_placeholder = st.empty()
            with st.spinner("AI Agent ƒëang suy nghƒ©..."):
                try:
                    response = main_agent.run(
                        user_question=prompt, 
                        user_id=st.session_state.current_user
                    )
                except Exception as e: 
                    response = f"ƒê√£ x·∫£y ra l·ªói: {e}"
            
            response_placeholder.markdown(response)
        
        # L∆∞u response v√†o session state
        st.session_state.messages.append({"role": "assistant", "content": response})
        # st.rerun()
st.markdown(
    """
    <div style="
        text-align: center;
        color: gray;
        font-size: 0.9rem;
        margin-top: 3rem;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
    ">
        ‚ú® Developed by <b>Truong Thanh Minh</b> ‚ú®
    </div>
    """,
    unsafe_allow_html=True
)